<% content_for :navbar do %>
  <ul class="navbar-nav mr-auto">
    <li class="nav-item">
      <%= link_to " Back to teacher view", teacher_lectures_path(@lecture.teacher, school_class_id: @lecture.school_class), class: "btn btn-primary mdi mdi-arrow-left", id: "back-to-teacher"%>
    </li>
  </ul>
  <span class="navbar-brand"><%= @lecture.name %></span>
<% end %>

<div class="row">
  <div class="col-sm">
    <h3>School Class: <%= @lecture.school_class.class_to_s %></h3>
  </div>
  <div class="col-sm">
    <h3>Subject: <%= @lecture.subject %></h3>
  </div>
  <div class="col-sm">
    <h3>Date: <%= @lecture.date %></h3>
  </div>
</div>

<%= form_with(model: @lecture, id: "topics-edit") do |f| %>
  <%= f.text_field :topics %>
  <%= f.submit "Update Topics", id: "submit-topics-edit", disabled: "disabled" %>
<% end %>

<div class="row">
  <div class="col-sm">
    <%= link_to 'Add Mark', new_mark_path(params: { school_class_id: @lecture.school_class, teacher_id: @lecture.teacher }), {remote: true, 'data-toggle' =>  "modal", 'data-target' => '#mark-modal', class: 'btn btn-primary btn-lg'}  %>
  </div>
  <div class="col-sm">
    <%= link_to "Add Assignments", new_assignment_path(params: { school_class_id: @lecture.school_class, teacher_id: @lecture.teacher, lecture_id: @lecture.id }), {remote: true, 'data-toggle' => "modal", 'data-target' => '#assignment-modal', class: 'btn btn-primary btn-lg'} %>
  </div>
</div>

<div class="accordion" id="lecture-tables">
  <div class="card">
    <div class="card-header" id="headingOne">
      <h5 class="mb-0">
        <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#marks-table" aria-expanded="true" aria-controls="marks-table">
          View Marks
        </button>
      </h5>
    </div>

    <div id="marks-table" class="collapse" aria-labelledby="headingOne" data-parent="#lecture-tables">
      <div class="card-body">
        <table id="marks">
          <thead>
          <tr>
            <th>Teacher</th>
            <th>Mark</th>
            <th>Subject</th>
            <th>Student</th>
            <th>Mark date</th>
            <th>Notes</th>
            <th colspan="3"></th>
          </tr>
          </thead>
          <tbody id="marks-body">
          <%= render partial: 'marks/mark', collection: @lecture.teacher.marks.sort_by(&:date) %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="card-header" id="headingTwo">
      <h5 class="mb-0">
        <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#assignments-table" aria-expanded="false" aria-controls="assignments-table">
          View Assignments
        </button>
      </h5>
    </div>
    <div id="assignments-table" class="collapse" aria-labelledby="headingTwo" data-parent="#lecture-tables">
      <div class="card-body">
        <table id="assignments">
          <thead>
          <tr>
            <th>Name</th>
            <th>Subject</th>
            <th>Expiry Date</th>
            <th>School Class</th>
            <th>Teacher</th>
            <th>Lecture</th>
            <th colspan="3"></th>
          </tr>
          </thead>
          <tbody id="assignments-body">
          <%= render partial: 'assignments/assignment', collection: @lecture.teacher.assignments.where('expiry_date > ?', @lecture.start_time).where(subject: @lecture.subject).sort_by(&:expiry_date) %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="card-header" id="headingThree">
      <h5 class="mb-0">
        <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#attendance-table" aria-expanded="false" aria-controls="attendance-table">
          Manage Student Attendance
        </button>
      </h5>
    </div>
    <div id="attendance-table" class="collapse" aria-labelledby="headingThree" data-parent="#lecture-tables">
      <div class="card-body">
        <table id="attendances">
          <thead>
          <tr>
            <th>Student</th>
            <th>Attendance</th>
          </tr>
          </thead>
          <tbody id="attendances-body">
          <%= render partial: 'attendances/attendance', collection: @lecture.school_class.attendances.sort_by{ |a| a[:student_name] } %>
          </tbody>
        </table>
        <div>
          <button class="btn btn-success" id="submit-attendances" disabled onclick="update_attendances()">Send Data</button>
        </div>
      </div>
    </div>
  </div>
</div>

<%= render partial: 'marks/modal_form' %>
<%= render partial: 'assignments/modal_form' %>
<%= render partial: 'assignments/modal_show' %>

<script type="text/javascript">
    $(document).on('ready turbolinks:load', function (e) {
        $('input[type=checkbox][data-toggle^=toggle]').bootstrapToggle();
    });
    $(document).ready(function () {
        var today = new Date();
        var lecture_date = new Date("<%= @lecture.date.split('/').reverse.join('-') %>");
        if(today > new Date(lecture_date.getTime() + 86400000) || today < new Date(lecture_date.getTime() - 86400000)) { disable_clickable() }
    });
    function disable_clickable() {
        $('a:not(#back-to-teacher)').addClass('disabled');
        $('input, .toggle').prop('disabled', true);
    }
    function get_attendances() {
        var students_ids = {
            absents: [],
            presents: []
        };
        $('input[type="checkbox"]').each(function(){
            if(this.checked){ students_ids['presents'].push(this.id)}
            else { students_ids['absents'].push(this.id)}
        });
        return students_ids;
    }
    function update_attendances(){
        var students_ids = get_attendances();
        $.ajax({
            type: 'POST',
            url: "/lectures/<%= @lecture.id %>/attendances",
            data: { "school_class_id": "<%= @lecture.school_class.id %>", "students_ids": students_ids},
            success: function (data) {
                console.log(data);
            }
        })
    }
    $(document).on('change','#attendances > tbody > tr > td',function(){
        $('#submit-attendances').prop("disabled", false)
    });
    $(document).on('keyup', '#topics-edit input[type=text]', function () {
        $('input[type=submit]').prop('disabled', false);
    });
    $('form#topics-edit input[type=submit]').click( function () {
      $(this).prop("disabled", true);
      $('form#topics-edit').submit();
    })
</script>