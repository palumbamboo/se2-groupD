<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<% content_for :navbar do %>
  <ul class="navbar-nav mr-auto">
    <li class="nav-item">
      <%= link_to " Back", teacher_lectures_path(@lecture.teacher, school_class_id: @lecture.school_class), class: "btn btn-primary mdi mdi-arrow-left", id: "back-to-teacher"%>
    </li>
  </ul>
  <span class="navbar-brand"><%= @lecture.name %></span>
<% end %>

<div class="row">
  <div class="col-xs-12 col-md-3" style="border-right: solid 2px #74a4b5; box-shadow: 5px 0 5px -5px #555;">
    <div class="col-sm">
      <h3>School Class: <%= @lecture.school_class.class_to_s %></h3>
    </div>
    <div class="col-sm">
      <h3>Subject: <%= @lecture.subject %></h3>
    </div>
    <div class="col-sm">
      <h3>Date: <%= @lecture.date %></h3>
    </div>
    <br>
    <%= form_with(model: @lecture, id: "topics-edit") do |f| %>
      <div class="col-md-12">
        <%= f.text_area :topics %>
      </div>

      <div class="row">
        <div class="col-md-3"></div>
        <div class="col-md-6">
          <br>
          <%= f.submit "Update Topics", id: "submit-topics-edit", disabled: "disabled", class: "btn btn-primary" %>
        </div>
      </div>
    <% end %>
  </div>
  <div class="col-xs-12 col-md-9">
    <ul class="nav nav-tabs" id="nav-tab-lecture" role="tablist">
      <li class="nav-item">
        <a class="nav-link active" id="nav-attendance-tab" data-toggle="tab" href="#nav-attendance" role="tab" aria-controls="nav-attendance" aria-selected="true">Students' attendance</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="nav-marks-tab" data-toggle="tab" href="#nav-marks" role="tab" aria-controls="nav-marks" aria-selected="true">Marks</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="nav-assignments-tab" data-toggle="tab" href="#nav-assignments" role="tab" aria-controls="nav-assignments" aria-selected="true">Assignments</a>
      </li>
    </ul>

    <div class="tab-content" id="pills-tabContent">
      <div class="tab-pane fade show active" id="nav-attendance" role="tabpanel" aria-labelledby="nav-attendance-tab">
        <br>
        <table id="attendances" class="table table-striped table-sm" style="table-layout: fixed;">
          <thead>
          <tr>
            <th>Student</th>
            <th>Attendance</th>
          </tr>
          </thead>
          <tbody id="attendances-body">
          <%= render partial: 'attendances/attendance', collection: @lecture.school_class.attendances(@lecture.start_time).sort_by{ |a| a[:student_name] } %>
          </tbody>
        </table>
        <div>
          <button class="btn btn-success" id="submit-attendances" disabled onclick="update_attendances()">Send Data</button>
        </div>
      </div>
      <div class="tab-pane fade" id="nav-marks" role="tabpanel" aria-labelledby="nav-marks-tab">
        <br>
        <%= link_to ' Add mark', new_mark_path(params: { school_class_id: @lecture.school_class, teacher_id: @lecture.teacher }), {remote: true, 'data-toggle' =>  "modal", 'data-target' => '#mark-modal', class: 'btn btn-primary mdi mdi-plus-circle', id: 'new_mark_lecture'}  %>
        <br>
        <div style="overflow: auto">
        <table id="marks" class="table table-striped table-sm">
          <thead>
          <tr>
            <th>Teacher</th>
            <th>Mark</th>
            <th>Subject</th>
            <th>Student</th>
            <th>Mark date</th>
            <th>Notes</th>
            <th></th>
            <th></th>
          </tr>
          </thead>
          <tbody id="marks-body">
          <%= render partial: 'marks/mark', collection: @lecture.teacher.marks.sort_by(&:date) %>
          </tbody>
        </table>
        </div>
      </div>
      <div class="tab-pane fade" id="nav-assignments" role="tabpanel" aria-labelledby="nav-assignments-tab">
        <br>
        <%= link_to " Add Assignments", new_assignment_path(params: { school_class_id: @lecture.school_class, teacher_id: @lecture.teacher, lecture_id: @lecture.id }),
                    {remote: true, 'data-toggle' => "modal", 'data-target' => '#assignment-modal', class: 'btn btn-primary mdi mdi-plus-circle', id: 'new_assignment_lecture'} %>
        <br>
        <div style="overflow: auto">
        <table id="assignments" class="table table-striped table-sm">
          <thead>
          <tr>
            <th style="width: 15%">Name</th>
            <th style="width: 18%">Subject</th>
            <th style="width: 17%">Expiry Date</th>
            <th style="width: 17%">School Class</th>
            <th style="width: 17%">Teacher</th>
            <th style="width: 17%">Lecture</th>
            <th style="width: 10%"></th>
            <th style="width: 10%"></th>
            <th style="width: 10%"></th>
          </tr>
          </thead>
          <tbody id="assignments-body">
          <%= render partial: 'assignments/assignment', collection: @lecture.teacher.assignments.where('expiry_date > ?', @lecture.start_time).where(subject: @lecture.subject).sort_by(&:expiry_date) %>
          </tbody>
        </table>
        </div>
      </div>
    </div>
  </div>
</div>

<%= render partial: 'marks/modal_form' %>
<%= render partial: 'assignments/modal_form' %>
<%= render partial: 'assignments/modal_show' %>
<%= render partial: 'lectures/modal_error' %>

<script type="text/javascript">
  var togglePressed = false;
  var toggleID;
  var timeChanged = false;
  var previousState;
  var closedPressed = false;
  var students_ids = {
      absents: [],
      late: [],
      early: []
  };

    $(document).on('ready turbolinks:load', function (e) {
        $('input[type=checkbox][data-toggle^=toggle]').bootstrapToggle();
        $('[data-toggle="popover"]').popover(
            {
                html: true,
                container: 'body',
                sanitize: false,
            }
        );

        $('[data-toggle="popover"]').click(function (e) {
            //e.stopPropagation();
            let elementToBeChecked = e.target;
            elementToBeChecked.classList.contains('toggle-on') ? previousState = true : previousState = false;

            let buttonID = elementToBeChecked.parentElement.parentElement.children[0].id;
            if($('[absence-button="true"][id='+buttonID+']')[0] !== undefined) {
                $('[absence-button="true"][id='+buttonID+']')[0].onclick = function () {
                    $('[data-toggle="popover"]').popover('hide');
                    let studentName = $('td#'+buttonID)[0].innerHTML;
                    let tooltip = document.createElement('a');
                    tooltip.setAttribute('data-toggle', 'tooltip');
                    tooltip.setAttribute('data-placement','right');
                    tooltip.setAttribute('title','' + studentName + ' was absent since the first hour');
                    let infoIcon = document.createElement('i');
                    infoIcon.classList = "fa fa-info-circle";
                    let infoButton = document.createElement('button').appendChild(infoIcon);
                    tooltip.appendChild(infoButton);
                    $('[data-toggle="popover"][id='+buttonID+']')[0].parentElement.appendChild(tooltip);
                    $('[data-toggle="popover"][id='+buttonID+']')[0].setAttribute('toggled', 'true');

                    $('#submit-attendances').prop("disabled", false);

                    $('[data-toggle="tooltip"]').tooltip(
                        {
                            container: 'body',
                        }
                    );

                    $('[data-toggle="popover"][id='+buttonID+']').popover('disable');

                    students_ids['absents'].push(buttonID);

                    togglePressed = timeChanged = closedPressed = false;
                    toggleID = -1;
                }
            }

            if( elementToBeChecked.parentElement.parentElement.parentElement.getAttribute('toggled') == "true" ) {
                let id = elementToBeChecked.parentElement.parentElement.parentElement.id;
                if( elementToBeChecked.classList.contains('toggle-on') ) {
                    $('input[type="checkbox"][id=' + id +']').prop('checked', true).change(); // mi aspettavo che al posto di true ci fosse false, ma okay...
                    students_ids['late'].splice(students_ids['late'].indexOf(id), 1);
                }
                else if( elementToBeChecked.classList.contains('toggle-off') ) {
                    $('input[type="checkbox"][id=' + id +']').prop('checked', false).change(); // mi aspettavo che al posto di false ci fosse true, ma okay...
                    students_ids['early'].splice(students_ids['early'].indexOf(id), 1);
                }

                let tooltip = elementToBeChecked.parentElement.parentElement.parentElement.parentElement.children[1];
                elementToBeChecked.parentElement.parentElement.parentElement.parentElement.removeChild(tooltip);

                elementToBeChecked.parentElement.parentElement.parentElement.removeAttribute('toggled');
                $('[data-toggle="popover"][id='+id+']').popover('enable');

                if($('.fa-info-circle').length == 0) {
                    $('#submit-attendances').prop("disabled", true);
                }

                return;
            }
            if( togglePressed == true ) {
                $('[data-toggle="popover"]').popover('hide');
                togglePressed = false;
                toggleID = -1;
                timeChanged = false;
            }
            else {
                togglePressed = true;
            }

            toggleID = e.target.parentElement.parentElement.parentElement.id;

            $('input[type="time"]').change(function() {
                timeChanged = true;
            });
        });

        $(document).click(function (e) {
            if(!togglePressed) {
                return;
            }

            if ( ($('[data-toggle="popover"]').has(e.target).length == 0) && ($('[role="tooltip"]').has(e.target).length == 0) ) {
                if(timeChanged == true) {
                    $('[data-toggle="popover"]').popover('hide');
                }
                else {
                    $('#lecture-error-modal').modal('show');
                }
            }
            else if( $(e.target).is('.close') ) {
                let id = e.target.id;
                $('input[type="checkbox"][id=' + id +']').prop('checked', previousState).change();
                closedPressed = true;
                $('[data-toggle="popover"]').popover('hide');
            }
        });

        for(let i = 0; i < $('[data-toggle="popover"]').length; i++) {
            let id = $('[data-toggle="popover"]')[i].id;
            $('[data-toggle="popover"][id='+id+']').on('hide.bs.popover', function () {
                if( id == toggleID && !closedPressed && timeChanged && togglePressed ) {
                    let tooltip = document.createElement('a');
                    tooltip.setAttribute('data-toggle', 'tooltip');
                    tooltip.setAttribute('data-placement','right');
                    let time = $('input[type="time"][id='+id+']')[0].value;
                    let studentName = $('td#'+id)[0].innerHTML;
                    let enterExitVerb;
                    if( $('[data-toggle="popover"]')[i].children[0].classList.contains('btn-success') ) {
                        enterExitVerb = "entered";
                        students_ids['late'].push({"id": id, "time": time});
                    }
                    else {
                        enterExitVerb = "exited";
                        students_ids['early'].push({"id": id, "time": time});
                    }
                    tooltip.setAttribute('title','' + studentName + ' ' + enterExitVerb + ' class at ' + time);
                    let infoIcon = document.createElement('i');
                    infoIcon.classList = "fa fa-info-circle";
                    let infoButton = document.createElement('button').appendChild(infoIcon);
                    tooltip.appendChild(infoButton);

                    this.parentElement.appendChild(tooltip);
                    this.setAttribute('toggled', 'true');

                    $('#submit-attendances').prop("disabled", false);

                    $('[data-toggle="tooltip"]').tooltip(
                        {
                          container: 'body',
                        }
                    );

                    $('[data-toggle="popover"][id='+id+']').popover('disable');

                    togglePressed = timeChanged = closedPressed = false;
                    toggleID = -1;
                }
                else if( closedPressed == true ) {
                    togglePressed = timeChanged = closedPressed = false;
                    toggleID = -1;
                }
            });
        }
    });
    $(document).ready(function () {
        var today = new Date();
        var lecture_date = new Date("<%= @lecture.date.split('/').reverse.join('-') %>");
        if(today > new Date(lecture_date.getTime() + 86400000) || today < new Date(lecture_date.getTime() - 86400000)) { disable_clickable() }
    });
    function disable_clickable() {
        $('a:not(#back-to-teacher, .nav-link)').addClass('disabled');
        $('a:not(#back-to-teacher, .nav-link)').prop('disabled', true);
        $('input, .toggle').prop('disabled', true);
        $('input, .toggle').addClass('disabled');
    }

    function update_attendances(){
        $.ajax({
            type: 'POST',
            url: "/lectures/<%= @lecture.id %>/attendances",
            data: { "school_class_id": "<%= @lecture.school_class_id %>", "students_ids": students_ids},
            success: function (data) {
                console.log(data);
            }
        })
    }

    $(document).on('keyup', '#topics-edit textarea', function () {
        $('input[type=submit]').prop('disabled', false);
    });
    $('form#topics-edit input[type=submit]').click( function () {
        $(this).prop("disabled", true);
        $('form#topics-edit').submit();
    });

</script>